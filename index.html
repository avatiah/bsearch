<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ü–æ–∏—Å–∫ –∑–∞—Ö–æ—Ä–æ–Ω–µ–Ω–∏–π | –ú–æ–±–∏–ª—å–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --card: #ffffff;
            --text: #0f172a;
            --secondary: #64748b;
            --highlight: #fef08a;
        }

        body { 
            background: var(--bg); 
            color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            padding-bottom: 80px; /* –ú–µ—Å—Ç–æ –¥–ª—è —Ñ—É—Ç–µ—Ä–∞ */
        }

        /* –®–∞–ø–∫–∞ —Å–∞–π—Ç–∞ */
        .header {
            background: var(--card);
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 100;
            text-align: center;
        }

        .header h1 { font-size: 1.2rem; margin: 0; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* –ü–æ–∏—Å–∫–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ */
        .search-card {
            background: var(--card);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .search-box { display: flex; flex-direction: column; gap: 12px; }

        input { 
            padding: 16px; 
            border: 2px solid #e2e8f0; 
            border-radius: 12px; 
            font-size: 16px; 
            outline: none;
            -webkit-appearance: none; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ iOS */
        }

        input:focus { border-color: var(--primary); }

        .btn-main { 
            background: var(--primary); 
            color: white; 
            border: none; 
            padding: 16px; 
            border-radius: 12px; 
            font-weight: bold; 
            font-size: 16px;
            cursor: pointer;
        }

        /* –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ */
        .reset-container { display: none; margin-bottom: 15px; text-align: center; }
        .btn-reset {
            background: transparent;
            color: var(--secondary);
            border: 1px solid var(--secondary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ / –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .results-container { margin-top: 10px; }

        @media (max-width: 640px) {
            table thead { display: none; } /* –°–∫—Ä—ã–≤–∞–µ–º —à–∞–ø–∫—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            table, tbody, tr, td { display: block; width: 100%; }
            tr { 
                background: var(--card); 
                margin-bottom: 15px; 
                border-radius: 16px; 
                padding: 15px; 
                box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            }
            td { 
                padding: 8px 0; 
                border: none; 
                display: flex; 
                justify-content: space-between; 
                font-size: 15px;
            }
            td::before { 
                content: attr(data-label); 
                font-weight: 600; 
                color: var(--secondary); 
                font-size: 13px;
                text-transform: uppercase;
            }
            .td-name { font-size: 18px; font-weight: bold; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 10px; display: block; }
            .td-name::before { display: none; }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É) */
        @media (min-width: 641px) {
            table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; }
            th { background: #f8fafc; padding: 15px; text-align: left; font-size: 12px; color: var(--secondary); cursor: pointer; border-bottom: 2px solid #e2e8f0; }
            td { padding: 15px; border-bottom: 1px solid #f1f5f9; }
        }

        .highlight { background: var(--highlight); font-weight: bold; padding: 0 2px; }
        
        .map-btn {
            display: inline-block;
            background: #f1f5f9;
            color: var(--primary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        /* –§—É—Ç–µ—Ä */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            border-top: 1px solid #e2e8f0;
            text-align: center;
            font-size: 12px;
            color: var(--secondary);
            line-height: 1.5;
        }

        #status { font-size: 14px; color: var(--secondary); margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="header">
    <h1> Cemetery Search </h1>
</div>

<div class="container">
    <div class="search-card" id="searchSection">
        <div id="status">–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞</div>
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="–ù–∞–ø—Ä: –ì–µ—Ä–º–∞–Ω—Å–∫–∏–π" inputmode="search">
            <button class="btn-main" onclick="search()">–ù–ê–ô–¢–ò –ß–ï–õ–û–í–ï–ö–ê</button>
        </div>
    </div>

    <div class="reset-container" id="resetBox">
        <button class="btn-reset" onclick="resetSearch()">‚Üê –ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ–∏—Å–∫</button>
    </div>
    
    <div class="results-container">
        <table id="resultsTable">
            <thead>
                <tr>
                    <th onclick="sortTable('full_name')">–§–ò–û</th>
                    <th onclick="sortTable('birth_date')">–†–æ–∂–¥–µ–Ω–∏–µ</th>
                    <th onclick="sortTable('death_date')">–°–º–µ—Ä—Ç—å</th>
                    <th onclick="sortTable('grave_number')">–ú–æ–≥–∏–ª–∞</th>
                    <th onclick="sortTable('sector')">–°–µ–∫—Ç–æ—Ä</th>
                    <th>–ö–∞—Ä—Ç–∞</th>
                </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>
    </div>
</div>

<footer class="footer">
    <strong>–û–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä –ø–∞–º—è—Ç–∏</strong><br>
    –î–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —è–≤–ª—è–µ—Ç—Å—è –¥–æ—Å—Ç–æ—è–Ω–∏–µ–º –æ–±—â–µ—Å—Ç–≤–∞ –∏ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –≤—Å–µ–º –Ω–∞–º. <br>
    –ò—Å—Ç–æ—Ä–∏—è –∫–∞–∂–¥–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞ ‚Äî —ç—Ç–æ —á–∞—Å—Ç—å –Ω–∞—à–µ–π –æ–±—â–µ–π –∏—Å—Ç–æ—Ä–∏–∏.
</footer>

<script>
    const SUPABASE_URL = 'https://grqwgutmyakfagegqupy.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_SHiQs5LAw5FbDQpu6N3b1Q_bM_Ms1DI';
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentData = [];

    async function search() {
        const query = document.getElementById('searchInput').value.trim();
        const status = document.getElementById('status');
        const tbody = document.getElementById('resultsBody');
        
        if (!query) return;

        status.innerText = 'üîç –ò—â–µ–º –≤ –∞—Ä—Ö–∏–≤–∞—Ö...';
        
        try {
            const { data, error } = await _supabase
                .from('burials')
                .select('*')
                .ilike('full_name', `%${query}%`);

            if (error) throw error;

            if (!data || data.length === 0) {
                status.innerText = '‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
                return;
            }

            currentData = data;
            renderTable(data, query);
            
            // –ü–ª–∞–≤–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ø–æ–∏—Å–∫–∞ –∏ –ø–æ–∫–∞–∑ –∫–Ω–æ–ø–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('resetBox').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });

        } catch (err) {
            status.innerText = '–û—à–∏–±–∫–∞: ' + err.message;
        }
    }

    function renderTable(data, query = '') {
        const tbody = document.getElementById('resultsBody');
        tbody.innerHTML = '';

        data.forEach(item => {
            const mapCell = (item.latitude && item.longitude) 
                ? `<a href="https://www.google.com/maps/search/?api=1&query=${item.latitude},${item.longitude}" target="_blank" class="map-btn">üìç –ù–ê –ö–ê–†–¢–ï</a>`
                : '-';

            const highlightedName = query ? 
                item.full_name.replace(new RegExp(`(${query})`, 'gi'), '<span class="highlight">$1</span>') : 
                item.full_name;

            tbody.innerHTML += `
                <tr>
                    <td class="td-name" data-label="–§–ò–û">${highlightedName}</td>
                    <td data-label="–†–æ–∂–¥–µ–Ω–∏–µ">${item.birth_date || '-'}</td>
                    <td data-label="–°–º–µ—Ä—Ç—å">${item.death_date || '-'}</td>
                    <td data-label="–ú–æ–≥–∏–ª–∞">${item.grave_number || '-'}</td>
                    <td data-label="–°–µ–∫—Ç–æ—Ä">${item.sector || '-'}</td>
                    <td data-label="–ö–∞—Ä—Ç–∞">${mapCell}</td>
                </tr>`;
        });
    }

    function resetSearch() {
        document.getElementById('searchSection').style.display = 'block';
        document.getElementById('resetBox').style.display = 'none';
        document.getElementById('resultsBody').innerHTML = '';
        document.getElementById('searchInput').value = '';
        document.getElementById('status').innerText = '–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø–æ–∏—Å–∫–∞';
    }

    function sortTable(column) {
        const sorted = [...currentData].sort((a, b) => 
            (a[column] || '').toString().localeCompare((b[column] || '').toString(), 'ru')
        );
        renderTable(sorted, document.getElementById('searchInput').value.trim());
    }

    document.getElementById('searchInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') search();
    });
</script>

</body>
</html>
